<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager - ON AFRICA TP</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/x8zq9Qvf/2025-06-29-T075316-796.png" />
    
    <!-- Netlify Identity Widget - Load synchronously -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Custom styles for CMS -->
    <style>
      /* Custom CMS styling */
      .nc-app-header {
        background: linear-gradient(135deg, #08295f, #37bdf8) !important;
      }
      
      .nc-app-header h1 {
        color: white !important;
      }
      
      .nc-entryEditor-widget {
        margin-bottom: 24px !important;
      }
      
      .nc-controlPane-widget {
        border: 2px solid #e2e8f0 !important;
        border-radius: 12px !important;
        padding: 16px !important;
      }
      
      .nc-controlPane-widget:focus-within {
        border-color: #37bdf8 !important;
        box-shadow: 0 0 0 3px rgba(55, 189, 248, 0.1) !important;
      }
      
      /* Loading screen */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Poppins', sans-serif;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
      }
      
      .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      .loading-logo {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        animation: pulse 2s infinite;
      }
      
      .loading-text {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
        text-align: center;
      }
      
      .loading-subtitle {
        font-size: 16px;
        opacity: 0.8;
        text-align: center;
        margin-bottom: 32px;
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Authentication required screen */
      .auth-required {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Poppins', sans-serif;
        z-index: 9999;
      }
      
      .auth-card {
        background: white;
        color: #08295f;
        padding: 48px;
        border-radius: 24px;
        text-align: center;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      }
      
      .auth-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        color: white;
        font-size: 32px;
      }
      
      .auth-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }
      
      .auth-description {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
        color: #64748b;
      }
      
      .auth-button {
        background: linear-gradient(135deg, #08295f, #37bdf8);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 8px;
        min-width: 160px;
      }
      
      .auth-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(8, 41, 95, 0.3);
      }
      
      .auth-button.secondary {
        background: white;
        color: #08295f;
        border: 2px solid #08295f;
      }
      
      .auth-button.secondary:hover {
        background: #08295f;
        color: white;
      }
      
      .auth-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .auth-button:disabled:hover {
        transform: none;
        box-shadow: none;
      }
      
      /* Success message */
      .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        animation: slideIn 0.5s ease-out;
      }
      
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      /* Force Netlify Identity Widget visibility and z-index */
      .netlify-identity-widget {
        z-index: 999999 !important;
        position: fixed !important;
      }
      
      iframe[src*="netlify-identity-widget"] {
        z-index: 999999 !important;
        position: fixed !important;
      }
      
      /* Ensure modal backdrop is visible */
      .netlify-identity-widget .netlify-identity-widget-modal {
        z-index: 999999 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: rgba(0, 0, 0, 0.8) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loading-logo">
        ğŸ¢
      </div>
      <div class="loading-text">ON AFRICA TP</div>
      <div class="loading-subtitle">ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</div>
      <div class="loading-spinner"></div>
    </div>

    <!-- Authentication Required Screen -->
    <div id="authRequired" class="auth-required" style="display: none;">
      <div class="auth-card">
        <div class="auth-icon">ğŸ”</div>
        <h1 class="auth-title">Ù…Ø·Ù„ÙˆØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="auth-description">
          ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰. 
          ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ÙˆÙ„Ø©.
        </p>
        <div id="authButtons">
          <button id="loginButton" class="auth-button">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          </button>
          <button id="homeButton" class="auth-button secondary">
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹
          </button>
        </div>
        <div id="authStatus" style="margin-top: 20px; font-size: 14px; color: #64748b;"></div>
      </div>
    </div>

    <!-- Include the script that builds the page and powers Netlify CMS -->
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    
    <script>
      // State variables
      let isAuthenticated = false;
      let cmsInitialized = false;
      let identityInitialized = false;
      
      // Status update function
      function updateAuthStatus(message) {
        const statusEl = document.getElementById('authStatus');
        if (statusEl) {
          statusEl.textContent = message;
        }
        console.log(`Status: ${message}`);
      }
      
      // Function to show success message
      function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
          successDiv.remove();
        }, 4000);
      }
      
      // Initialize Netlify Identity with comprehensive error handling
      function initializeNetlifyIdentity() {
        console.log('ğŸ”§ Starting Netlify Identity initialization...');
        
        if (!window.netlifyIdentity) {
          console.error('âŒ Netlify Identity not available');
          updateAuthStatus('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
          showAuthRequired();
          return false;
        }
        
        if (identityInitialized) {
          console.log('âœ… Identity already initialized');
          return true;
        }
        
        try {
          updateAuthStatus('ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
          
          // Set up comprehensive event listeners
          window.netlifyIdentity.on("init", user => {
            console.log(`ğŸ¯ Identity initialized with user: ${user ? user.email : 'no user'}`);
            identityInitialized = true;
            
            if (user) {
              isAuthenticated = true;
              updateAuthStatus('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„ØŒ ØªØ­Ù…ÙŠÙ„ CMS...');
              initializeCMS();
            } else {
              updateAuthStatus('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
              showAuthRequired();
            }
          });
          
          window.netlifyIdentity.on("login", user => {
            console.log(`âœ… User logged in: ${user.email}`);
            isAuthenticated = true;
            updateAuthStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! ØªØ­Ù…ÙŠÙ„ CMS...');
            hideAuthRequired();
            initializeCMS();
            showSuccessMessage('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
          });
          
          window.netlifyIdentity.on("logout", () => {
            console.log("ğŸ‘‹ User logged out");
            isAuthenticated = false;
            updateAuthStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
            window.location.href = "/admin-login";
          });
          
          window.netlifyIdentity.on("error", err => {
            console.error(`âŒ Identity error: ${err.message || err}`);
            updateAuthStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ' + (err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            showAuthRequired();
          });
          
          window.netlifyIdentity.on("open", () => {
            console.log("ğŸ”“ Identity modal opened");
            updateAuthStatus('Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­Ø©');
          });
          
          window.netlifyIdentity.on("close", () => {
            console.log("ğŸ”’ Identity modal closed");
            if (!isAuthenticated) {
              updateAuthStatus('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
            }
          });
          
          // Initialize the widget
          console.log('ğŸ”§ Calling netlifyIdentity.init()...');
          window.netlifyIdentity.init({
            APIUrl: window.location.origin + '/.netlify/identity'
          });
          
          return true;
          
        } catch (error) {
          console.error(`âŒ ERROR initializing Identity: ${error.message}`);
          updateAuthStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
          showAuthRequired();
          return false;
        }
      }
      
      function initializeCMS() {
        if (cmsInitialized) {
          console.log('âœ… CMS already initialized');
          return;
        }
        
        try {
          updateAuthStatus('ØªÙ‡ÙŠØ¦Ø© CMS...');
          console.log('ğŸ”§ Starting CMS initialization...');
          
          if (typeof window.CMS === 'undefined') {
            throw new Error('Netlify CMS not loaded');
          }
          
          // Register custom preview templates if needed
          window.CMS.registerPreviewStyle('/admin/preview.css');
          
          window.CMS.init({
            config: {
              load_config_file: true,
              config_file_path: '/admin/config.yml'
            }
          });
          
          cmsInitialized = true;
          hideLoadingScreen();
          updateAuthStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ CMS Ø¨Ù†Ø¬Ø§Ø­!');
          console.log("âœ… CMS initialized successfully");
          showSuccessMessage('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­!');
          
        } catch (error) {
          console.error(`âŒ ERROR initializing CMS: ${error.message}`);
          updateAuthStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ CMS');
          showAuthRequired();
        }
      }
      
      function showLoadingScreen() {
        console.log('ğŸ“º Showing loading screen');
        document.getElementById('loadingScreen').style.display = 'flex';
        document.getElementById('authRequired').style.display = 'none';
      }
      
      function hideLoadingScreen() {
        console.log('ğŸ“º Hiding loading screen');
        const loadingScreen = document.getElementById('loadingScreen');
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);
      }
      
      function showAuthRequired() {
        console.log('ğŸ“º Showing auth required screen');
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('authRequired').style.display = 'flex';
      }
      
      function hideAuthRequired() {
        console.log('ğŸ“º Hiding auth required screen');
        document.getElementById('authRequired').style.display = 'none';
        showLoadingScreen();
      }
      
      function openLogin() {
        console.log('ğŸš€ Opening login modal');
        
        if (!window.netlifyIdentity) {
          updateAuthStatus('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
          return;
        }
        
        try {
          updateAuthStatus('ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
          window.netlifyIdentity.open('login');
        } catch (error) {
          console.error(`âŒ ERROR opening login: ${error.message}`);
          updateAuthStatus('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }
      }
      
      function goHome() {
        console.log('ğŸ  Redirecting to home page');
        window.location.href = '/';
      }
      
      // Set up event listeners
      function setupEventListeners() {
        console.log('ğŸ”§ Setting up event listeners...');
        
        // Login button
        const loginBtn = document.getElementById('loginButton');
        if (loginBtn) {
          loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ğŸ–±ï¸ Login button clicked');
            openLogin();
          });
        }
        
        // Home button
        const homeBtn = document.getElementById('homeButton');
        if (homeBtn) {
          homeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ğŸ–±ï¸ Home button clicked');
            goHome();
          });
        }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ DOM Content Loaded - Starting initialization');
        updateAuthStatus('ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...');
        
        setupEventListeners();
        
        let checkCount = 0;
        const maxChecks = 40;
        
        function checkAndInit() {
          checkCount++;
          console.log(`ğŸ” Check #${checkCount}/${maxChecks} for Netlify Identity...`);
          
          if (window.netlifyIdentity) {
            console.log('âœ… Netlify Identity found, initializing...');
            
            if (initializeNetlifyIdentity()) {
              const user = window.netlifyIdentity?.currentUser();
              if (user) {
                console.log(`ğŸ‘¤ User already authenticated: ${user.email}`);
                isAuthenticated = true;
                updateAuthStatus('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ØªØ­Ù…ÙŠÙ„ CMS...');
                initializeCMS();
              } else {
                console.log('ğŸ‘¤ No authenticated user found');
                updateAuthStatus('Ù…Ø·Ù„ÙˆØ¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                showAuthRequired();
              }
            } else {
              console.log('âŒ Failed to initialize Netlify Identity');
              updateAuthStatus('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©');
              showAuthRequired();
            }
          } else if (checkCount < maxChecks) {
            console.log(`â³ Netlify Identity not ready, retrying in 500ms...`);
            setTimeout(checkAndInit, 500);
          } else {
            console.log('âŒ Max checks reached, Netlify Identity not available');
            updateAuthStatus('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            showAuthRequired();
          }
        }
        
        checkAndInit();
      });
    </script>
  </body>
</html>