<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administration - ON AFRICA TP</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/x8zq9Qvf/2025-06-29-T075316-796.png" />
    
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
      }
      
      body {
        background: linear-gradient(135deg, #08295f, #37bdf8);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      
      .admin-container {
        background: white;
        border-radius: 24px;
        padding: 48px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      
      .admin-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #08295f, #37bdf8, #08295f);
        animation: shimmer 2s infinite;
      }
      
      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      
      .admin-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        color: white;
        font-size: 32px;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      
      .admin-title {
        font-size: 32px;
        font-weight: 700;
        color: #08295f;
        margin-bottom: 12px;
      }
      
      .admin-subtitle {
        font-size: 16px;
        color: #64748b;
        margin-bottom: 32px;
      }
      
      .status-message {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
      }
      
      .status-error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
      }
      
      .status-success {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #16a34a;
      }
      
      .status-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #2563eb;
      }
      
      .btn {
        width: 100%;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
      }
      
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #08295f, #37bdf8);
        color: white;
      }
      
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(8, 41, 95, 0.3);
      }
      
      .btn-secondary {
        background: white;
        color: #37bdf8;
        border: 2px solid #37bdf8;
      }
      
      .btn-secondary:hover:not(:disabled) {
        background: #37bdf8;
        color: white;
        transform: translateY(-2px);
      }
      
      .btn-tertiary {
        background: #f8fafc;
        color: #64748b;
        border: 1px solid #e2e8f0;
      }
      
      .btn-tertiary:hover:not(:disabled) {
        background: #e2e8f0;
        transform: translateY(-2px);
      }
      
      .security-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 12px;
        padding: 16px;
        margin-top: 24px;
        font-size: 12px;
        color: #2563eb;
        line-height: 1.5;
      }
      
      .footer-info {
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e2e8f0;
        font-size: 12px;
        color: #64748b;
      }
      
      .footer-info .powered-by {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }
      
      .footer-info .powered-by span {
        color: #37bdf8;
        font-weight: 600;
      }
      
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .user-info {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
        color: #16a34a;
      }
      
      .user-email {
        font-weight: 600;
        margin-top: 4px;
      }
      
      /* Custom login form */
      .custom-form {
        display: none;
        text-align: left;
      }
      
      .custom-form.active {
        display: block;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #08295f;
        font-size: 14px;
      }
      
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        font-family: 'Poppins', sans-serif;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #37bdf8;
        box-shadow: 0 0 0 3px rgba(55, 189, 248, 0.1);
      }
      
      .form-error {
        color: #dc2626;
        font-size: 14px;
        margin-top: 8px;
        display: none;
      }
      
      .form-error.show {
        display: block;
      }
      
      /* Responsive design */
      @media (max-width: 640px) {
        .admin-container {
          padding: 32px 24px;
          margin: 10px;
        }
        
        .admin-title {
          font-size: 28px;
        }
        
        .admin-icon {
          width: 64px;
          height: 64px;
          font-size: 24px;
        }
      }
      
      /* Hide default Netlify CMS */
      #nc-root {
        display: none !important;
      }
      
      /* Force hide any CMS elements until authenticated */
      body:not(.authenticated) #nc-root,
      body:not(.authenticated) [data-netlify-cms],
      body:not(.authenticated) .netlify-cms-app {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <!-- Admin Icon -->
      <div class="admin-icon">
        üõ°Ô∏è
      </div>
      
      <!-- Title -->
      <h1 class="admin-title">Administration</h1>
      <p class="admin-subtitle">Acc√®s au panneau de gestion du contenu</p>
      
      <!-- Status Messages -->
      <div id="statusMessage" class="status-message status-info" style="display: none;">
        <span id="statusIcon">‚ÑπÔ∏è</span>
        <span id="statusText">Initialisation...</span>
      </div>
      
      <!-- User Info (when logged in) -->
      <div id="userInfo" class="user-info" style="display: none;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span>üë§</span>
          <span>Connect√© en tant que:</span>
        </div>
        <div id="userEmail" class="user-email"></div>
      </div>
      
      <!-- Main Login Form -->
      <div id="mainForm">
        <button id="loginBtn" class="btn btn-primary">
          <span id="loginIcon">üîê</span>
          <span id="loginText">Se connecter</span>
        </button>
        
        <button id="signupBtn" class="btn btn-secondary">
          <span>üë§</span>
          <span>Cr√©er un compte</span>
        </button>
        
        <a href="/" class="btn btn-tertiary">
          <span>üè†</span>
          <span>Retour au site</span>
        </a>
        
        <!-- Alternative login button (hidden by default) -->
        <button id="customLoginBtn" class="btn btn-secondary" style="display: none;">
          <span>üìù</span>
          <span>Connexion alternative</span>
        </button>
      </div>
      
      <!-- Custom Login Form -->
      <div id="customForm" class="custom-form">
        <h3 style="text-align: center; margin-bottom: 24px; color: #08295f;">Connexion Alternative</h3>
        
        <form id="customLoginForm">
          <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input type="email" id="email" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="password">Mot de passe</label>
            <input type="password" id="password" class="form-input" required>
          </div>
          
          <button type="submit" class="btn btn-primary" id="customSubmitBtn">
            <span>üîê</span>
            <span>Se connecter</span>
          </button>
          
          <button type="button" class="btn btn-tertiary" onclick="showMainForm()">
            <span>‚Ü©Ô∏è</span>
            <span>Retour</span>
          </button>
        </form>
        
        <div id="customError" class="form-error"></div>
      </div>
      
      <!-- Authenticated Actions -->
      <div id="authenticatedActions" style="display: none;">
        <button id="accessCmsBtn" class="btn btn-primary">
          <span>‚öôÔ∏è</span>
          <span>Acc√©der au CMS</span>
        </button>
        
        <button id="logoutBtn" class="btn btn-tertiary">
          <span>üö™</span>
          <span>Se d√©connecter</span>
        </button>
      </div>
      
      <!-- Security Info -->
      <div class="security-info">
        <strong>üîê S√©curit√© :</strong> Seuls les utilisateurs autoris√©s peuvent acc√©der au panneau d'administration. 
        Toutes les tentatives de connexion sont enregistr√©es et surveill√©es.
      </div>
      
      <!-- Footer -->
      <div class="footer-info">
        <div>Syst√®me de gestion de contenu s√©curis√©</div>
        <div class="powered-by">
          <span>Powered by</span>
          <span>Netlify Identity</span>
          <span>&</span>
          <span>Netlify CMS</span>
        </div>
      </div>
    </div>

    <!-- Include Netlify CMS -->
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    
    <script>
      // Global state
      let isAuthenticated = false;
      let currentUser = null;
      let cmsInitialized = false;
      let identityInitialized = false;
      
      // DOM elements
      const statusMessage = document.getElementById('statusMessage');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const userInfo = document.getElementById('userInfo');
      const userEmail = document.getElementById('userEmail');
      const mainForm = document.getElementById('mainForm');
      const customForm = document.getElementById('customForm');
      const authenticatedActions = document.getElementById('authenticatedActions');
      const loginBtn = document.getElementById('loginBtn');
      const loginIcon = document.getElementById('loginIcon');
      const loginText = document.getElementById('loginText');
      const signupBtn = document.getElementById('signupBtn');
      const customLoginBtn = document.getElementById('customLoginBtn');
      const accessCmsBtn = document.getElementById('accessCmsBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const customLoginForm = document.getElementById('customLoginForm');
      const customSubmitBtn = document.getElementById('customSubmitBtn');
      const customError = document.getElementById('customError');
      
      // Utility functions
      function showStatus(message, type = 'info', icon = '‚ÑπÔ∏è') {
        statusMessage.style.display = 'flex';
        statusMessage.className = `status-message status-${type}`;
        statusIcon.textContent = icon;
        statusText.textContent = message;
      }
      
      function hideStatus() {
        statusMessage.style.display = 'none';
      }
      
      function setButtonLoading(button, loading, loadingText = 'Chargement...') {
        if (loading) {
          button.disabled = true;
          const spinner = document.createElement('div');
          spinner.className = 'loading-spinner';
          button.innerHTML = '';
          button.appendChild(spinner);
          button.appendChild(document.createTextNode(loadingText));
        } else {
          button.disabled = false;
        }
      }
      
      function showMainForm() {
        mainForm.style.display = 'block';
        customForm.classList.remove('active');
        customError.classList.remove('show');
      }
      
      function showCustomForm() {
        mainForm.style.display = 'none';
        customForm.classList.add('active');
      }
      
      function showAuthenticatedState(user) {
        isAuthenticated = true;
        currentUser = user;
        
        // Show user info
        userInfo.style.display = 'block';
        userEmail.textContent = user.email;
        
        // Hide login forms
        mainForm.style.display = 'none';
        customForm.classList.remove('active');
        
        // Show authenticated actions
        authenticatedActions.style.display = 'block';
        
        showStatus('Connexion r√©ussie!', 'success', '‚úÖ');
        
        // Auto-hide status after 2 seconds
        setTimeout(hideStatus, 2000);
      }
      
      function showUnauthenticatedState() {
        isAuthenticated = false;
        currentUser = null;
        
        // Hide user info and authenticated actions
        userInfo.style.display = 'none';
        authenticatedActions.style.display = 'none';
        
        // Show main form
        showMainForm();
        
        // Reset button states
        loginBtn.disabled = false;
        loginIcon.textContent = 'üîê';
        loginText.textContent = 'Se connecter';
        signupBtn.disabled = false;
      }
      
      function initializeCMS() {
        if (cmsInitialized) return;
        
        try {
          showStatus('Initialisation du CMS...', 'info', '‚öôÔ∏è');
          
          // Initialize Netlify CMS
          window.CMS.init({
            config: {
              load_config_file: true,
              config_file_path: '/admin/config.yml'
            }
          });
          
          cmsInitialized = true;
          
          // Hide the admin container and show CMS
          document.querySelector('.admin-container').style.display = 'none';
          document.getElementById('nc-root').style.display = 'block';
          document.body.classList.add('authenticated');
          
          console.log('‚úÖ CMS initialized successfully');
          
        } catch (error) {
          console.error('‚ùå Error initializing CMS:', error);
          showStatus('Erreur lors du chargement du CMS', 'error', '‚ùå');
        }
      }
      
      // Netlify Identity functions
      function initializeNetlifyIdentity() {
        if (!window.netlifyIdentity) {
          showStatus('Service d\'authentification non disponible', 'error', '‚ùå');
          customLoginBtn.style.display = 'block';
          return;
        }
        
        try {
          // Initialize Netlify Identity
          window.netlifyIdentity.init();
          
          // Set up event listeners
          window.netlifyIdentity.on('init', user => {
            identityInitialized = true;
            console.log('üéØ Identity initialized:', user ? user.email : 'no user');
            
            if (user) {
              showAuthenticatedState(user);
            } else {
              showUnauthenticatedState();
              showStatus('Veuillez vous connecter pour continuer', 'info', '‚ÑπÔ∏è');
            }
          });
          
          window.netlifyIdentity.on('login', user => {
            console.log('‚úÖ User logged in:', user.email);
            showAuthenticatedState(user);
            window.netlifyIdentity.close();
          });
          
          window.netlifyIdentity.on('signup', user => {
            console.log('‚úÖ User signed up:', user.email);
            showAuthenticatedState(user);
            window.netlifyIdentity.close();
          });
          
          window.netlifyIdentity.on('logout', () => {
            console.log('üëã User logged out');
            showUnauthenticatedState();
            showStatus('D√©connexion effectu√©e', 'info', '‚ÑπÔ∏è');
            
            // Reload page to reset CMS
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          });
          
          window.netlifyIdentity.on('error', err => {
            console.error('‚ùå Identity error:', err);
            showStatus('Erreur d\'authentification', 'error', '‚ùå');
            customLoginBtn.style.display = 'block';
          });
          
          window.netlifyIdentity.on('open', () => {
            console.log('üîì Identity modal opened');
          });
          
          window.netlifyIdentity.on('close', () => {
            console.log('üîí Identity modal closed');
            loginBtn.disabled = false;
            loginIcon.textContent = 'üîê';
            loginText.textContent = 'Se connecter';
            signupBtn.disabled = false;
          });
          
        } catch (error) {
          console.error('‚ùå Error initializing Identity:', error);
          showStatus('Erreur lors de l\'initialisation', 'error', '‚ùå');
          customLoginBtn.style.display = 'block';
        }
      }
      
      // Event handlers
      loginBtn.addEventListener('click', () => {
        if (!window.netlifyIdentity) {
          showStatus('Service d\'authentification non disponible', 'error', '‚ùå');
          customLoginBtn.style.display = 'block';
          return;
        }
        
        try {
          setButtonLoading(loginBtn, true, 'Connexion...');
          showStatus('Ouverture de la fen√™tre de connexion...', 'info', 'üîÑ');
          
          window.netlifyIdentity.open('login');
          
          // Timeout fallback
          setTimeout(() => {
            if (!isAuthenticated) {
              loginBtn.disabled = false;
              loginIcon.textContent = 'üîê';
              loginText.textContent = 'Se connecter';
              showStatus('D√©lai d\'attente d√©pass√©', 'error', '‚è∞');
              customLoginBtn.style.display = 'block';
            }
          }, 10000);
          
        } catch (error) {
          console.error('‚ùå Error opening login:', error);
          loginBtn.disabled = false;
          loginIcon.textContent = 'üîê';
          loginText.textContent = 'Se connecter';
          showStatus('Erreur lors de l\'ouverture de la connexion', 'error', '‚ùå');
          customLoginBtn.style.display = 'block';
        }
      });
      
      signupBtn.addEventListener('click', () => {
        if (!window.netlifyIdentity) {
          showStatus('Service d\'authentification non disponible', 'error', '‚ùå');
          return;
        }
        
        try {
          signupBtn.disabled = true;
          showStatus('Ouverture de la fen√™tre d\'inscription...', 'info', 'üîÑ');
          
          window.netlifyIdentity.open('signup');
          
          setTimeout(() => {
            signupBtn.disabled = false;
          }, 5000);
          
        } catch (error) {
          console.error('‚ùå Error opening signup:', error);
          signupBtn.disabled = false;
          showStatus('Erreur lors de l\'ouverture de l\'inscription', 'error', '‚ùå');
        }
      });
      
      customLoginBtn.addEventListener('click', () => {
        showCustomForm();
      });
      
      accessCmsBtn.addEventListener('click', () => {
        initializeCMS();
      });
      
      logoutBtn.addEventListener('click', () => {
        if (window.netlifyIdentity && currentUser) {
          window.netlifyIdentity.logout();
        }
      });
      
      // Custom login form handler
      customLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
          customError.textContent = 'Veuillez remplir tous les champs';
          customError.classList.add('show');
          return;
        }
        
        try {
          setButtonLoading(customSubmitBtn, true, 'Connexion...');
          customError.classList.remove('show');
          
          if (!window.netlifyIdentity || !window.netlifyIdentity.gotrue) {
            throw new Error('Service d\'authentification non disponible');
          }
          
          const user = await window.netlifyIdentity.gotrue.login(email, password, true);
          console.log('‚úÖ Custom login successful:', user.email);
          
          showAuthenticatedState(user);
          showMainForm();
          
        } catch (error) {
          console.error('‚ùå Custom login failed:', error);
          customError.textContent = 'Email ou mot de passe incorrect';
          customError.classList.add('show');
          
          customSubmitBtn.disabled = false;
          customSubmitBtn.innerHTML = '<span>üîê</span><span>Se connecter</span>';
        }
      });
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Admin page loaded');
        showStatus('Initialisation du syst√®me d\'authentification...', 'info', 'üîÑ');
        
        // Check if Netlify Identity is available
        let checkCount = 0;
        const maxChecks = 20;
        
        const checkIdentity = () => {
          checkCount++;
          
          if (window.netlifyIdentity) {
            console.log('‚úÖ Netlify Identity found');
            initializeNetlifyIdentity();
          } else if (checkCount < maxChecks) {
            setTimeout(checkIdentity, 500);
          } else {
            console.log('‚ùå Netlify Identity not available after maximum checks');
            showStatus('Service d\'authentification non disponible', 'error', '‚ùå');
            customLoginBtn.style.display = 'block';
          }
        };
        
        checkIdentity();
      });
      
      // Global functions for debugging
      window.adminDebug = {
        showCustomForm,
        showMainForm,
        initializeCMS,
        state: () => ({
          isAuthenticated,
          currentUser,
          cmsInitialized,
          identityInitialized
        })
      };
    </script>
  </body>
</html>