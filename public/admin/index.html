<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager - ON AFRICA TP</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/x8zq9Qvf/2025-06-29-T075316-796.png" />
    
    <!-- Netlify Identity Widget - Load synchronously -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Custom styles for CMS -->
    <style>
      /* Custom CMS styling */
      .nc-app-header {
        background: linear-gradient(135deg, #08295f, #37bdf8) !important;
      }
      
      .nc-app-header h1 {
        color: white !important;
      }
      
      .nc-entryEditor-widget {
        margin-bottom: 24px !important;
      }
      
      .nc-controlPane-widget {
        border: 2px solid #e2e8f0 !important;
        border-radius: 12px !important;
        padding: 16px !important;
      }
      
      .nc-controlPane-widget:focus-within {
        border-color: #37bdf8 !important;
        box-shadow: 0 0 0 3px rgba(55, 189, 248, 0.1) !important;
      }
      
      /* Loading screen */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Poppins', sans-serif;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
      }
      
      .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      .loading-logo {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        animation: pulse 2s infinite;
      }
      
      .loading-text {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
        text-align: center;
      }
      
      .loading-subtitle {
        font-size: 16px;
        opacity: 0.8;
        text-align: center;
        margin-bottom: 32px;
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Authentication required screen */
      .auth-required {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Poppins', sans-serif;
        z-index: 9999;
      }
      
      .auth-card {
        background: white;
        color: #08295f;
        padding: 48px;
        border-radius: 24px;
        text-align: center;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      }
      
      .auth-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        color: white;
        font-size: 32px;
      }
      
      .auth-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }
      
      .auth-description {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
        color: #64748b;
      }
      
      .auth-button {
        background: linear-gradient(135deg, #08295f, #37bdf8);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 8px;
        min-width: 160px;
      }
      
      .auth-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(8, 41, 95, 0.3);
      }
      
      .auth-button.secondary {
        background: white;
        color: #08295f;
        border: 2px solid #08295f;
      }
      
      .auth-button.secondary:hover {
        background: #08295f;
        color: white;
      }
      
      .auth-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .auth-button:disabled:hover {
        transform: none;
        box-shadow: none;
      }
      
      /* Debug panel */
      .debug-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 11px;
        max-width: 350px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10000;
        display: none;
        border: 1px solid #37bdf8;
      }
      
      .debug-panel.show {
        display: block;
      }
      
      .debug-header {
        background: #37bdf8;
        color: white;
        padding: 4px 8px;
        margin: -12px -12px 8px -12px;
        font-weight: bold;
        font-size: 10px;
      }
      
      /* Force Netlify Identity Widget visibility and z-index */
      .netlify-identity-widget {
        z-index: 999999 !important;
        position: fixed !important;
      }
      
      iframe[src*="netlify-identity-widget"] {
        z-index: 999999 !important;
        position: fixed !important;
      }
      
      /* Ensure modal backdrop is visible */
      .netlify-identity-widget .netlify-identity-widget-modal {
        z-index: 999999 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: rgba(0, 0, 0, 0.8) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
      
      /* Custom login form for fallback */
      .custom-login-form {
        background: white;
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 400px;
        margin: 20px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #08295f;
      }
      
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #37bdf8;
        box-shadow: 0 0 0 3px rgba(55, 189, 248, 0.1);
      }
      
      .form-button {
        width: 100%;
        background: linear-gradient(135deg, #08295f, #37bdf8);
        color: white;
        border: none;
        padding: 14px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .form-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(8, 41, 95, 0.3);
      }
      
      .form-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
    </style>
  </head>
  <body>
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
      <div class="debug-header">üîß Debug Console</div>
      <div id="debugContent"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loading-logo">
        üè¢
      </div>
      <div class="loading-text">ON AFRICA TP</div>
      <div class="loading-subtitle">Chargement du syst√®me de gestion de contenu...</div>
      <div class="loading-spinner"></div>
    </div>

    <!-- Authentication Required Screen -->
    <div id="authRequired" class="auth-required" style="display: none;">
      <div class="auth-card">
        <div class="auth-icon">üîê</div>
        <h1 class="auth-title">Authentification Requise</h1>
        <p class="auth-description">
          Vous devez √™tre connect√© pour acc√©der au syst√®me de gestion de contenu. 
          Veuillez vous connecter avec vos identifiants autoris√©s.
        </p>
        <div id="authButtons">
          <button id="loginButton" class="auth-button">
            Se connecter
          </button>
          <button id="customLoginButton" class="auth-button secondary" style="display: none;">
            Connexion alternative
          </button>
          <button id="homeButton" class="auth-button secondary">
            Retour au site
          </button>
        </div>
        <div id="authStatus" style="margin-top: 20px; font-size: 14px; color: #64748b;"></div>
      </div>
    </div>

    <!-- Custom Login Form (Fallback) -->
    <div id="customLoginForm" class="auth-required" style="display: none;">
      <div class="custom-login-form">
        <h2 style="text-align: center; margin-bottom: 24px; color: #08295f;">Connexion Alternative</h2>
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input type="email" id="email" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="password">Mot de passe</label>
            <input type="password" id="password" class="form-input" required>
          </div>
          <button type="submit" class="form-button" id="submitLogin">
            Se connecter
          </button>
          <button type="button" class="auth-button secondary" onclick="showMainAuth()" style="width: 100%; margin-top: 12px;">
            Retour
          </button>
        </form>
        <div id="loginError" style="margin-top: 16px; color: #dc2626; text-align: center; display: none;"></div>
      </div>
    </div>

    <!-- Include the script that builds the page and powers Netlify CMS -->
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    
    <script>
      // Debug logging
      const DEBUG = true;
      let debugLogs = [];
      
      function debugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}`;
        debugLogs.push(logMessage);
        console.log(logMessage);
        
        if (DEBUG) {
          updateDebugPanel();
        }
      }
      
      function updateDebugPanel() {
        const panel = document.getElementById('debugPanel');
        const content = document.getElementById('debugContent');
        if (panel && content) {
          panel.classList.add('show');
          content.innerHTML = debugLogs.slice(-15).join('<br>');
          content.scrollTop = content.scrollHeight;
        }
      }
      
      // State variables
      let isAuthenticated = false;
      let cmsInitialized = false;
      let identityInitialized = false;
      let loginAttempts = 0;
      let identityWidget = null;
      let modalCheckInterval = null;
      
      // Status update function
      function updateAuthStatus(message) {
        const statusEl = document.getElementById('authStatus');
        if (statusEl) {
          statusEl.textContent = message;
        }
        debugLog(`Status: ${message}`);
      }
      
      // Disable/enable login button
      function setLoginButtonState(disabled, text) {
        const loginBtn = document.getElementById('loginButton');
        if (loginBtn) {
          loginBtn.disabled = disabled;
          if (text) loginBtn.textContent = text;
          debugLog(`Button state: ${disabled ? 'disabled' : 'enabled'}, text: ${text}`);
        }
      }
      
      // Enhanced Netlify Identity check
      function checkNetlifyIdentity() {
        debugLog('üîç Checking Netlify Identity availability...');
        
        if (typeof window.netlifyIdentity === 'undefined') {
          debugLog('‚ùå ERROR: window.netlifyIdentity is undefined');
          return false;
        }
        
        if (!window.netlifyIdentity) {
          debugLog('‚ùå ERROR: window.netlifyIdentity is null/false');
          return false;
        }
        
        const requiredMethods = ['init', 'open', 'close', 'on', 'off', 'currentUser'];
        const availableMethods = Object.keys(window.netlifyIdentity);
        const missingMethods = requiredMethods.filter(method => !availableMethods.includes(method));
        
        if (missingMethods.length > 0) {
          debugLog(`‚ùå ERROR: Missing methods: ${missingMethods.join(', ')}`);
          return false;
        }
        
        debugLog('‚úÖ SUCCESS: Netlify Identity is fully available');
        debugLog(`üìã Available methods: ${availableMethods.join(', ')}`);
        return true;
      }
      
      // Check if modal is actually visible
      function checkModalVisibility() {
        debugLog('üëÄ Checking modal visibility...');
        
        // Check for various modal selectors
        const modalSelectors = [
          '.netlify-identity-widget',
          '.netlify-identity-widget-modal',
          'iframe[src*="netlify-identity-widget"]',
          '[data-netlify-identity-widget]'
        ];
        
        let modalFound = false;
        modalSelectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          if (elements.length > 0) {
            debugLog(`‚úÖ Found modal elements with selector: ${selector} (${elements.length} elements)`);
            elements.forEach((el, index) => {
              const styles = window.getComputedStyle(el);
              debugLog(`   Element ${index}: display=${styles.display}, visibility=${styles.visibility}, opacity=${styles.opacity}, z-index=${styles.zIndex}`);
            });
            modalFound = true;
          }
        });
        
        if (!modalFound) {
          debugLog('‚ùå No modal elements found in DOM');
        }
        
        return modalFound;
      }
      
      // Force widget initialization with DOM manipulation
      function forceInitializeWidget() {
        debugLog('üîÑ Force initializing Netlify Identity widget...');
        
        try {
          identityWidget = window.netlifyIdentity;
          
          // Clear any existing modal elements
          const existingModals = document.querySelectorAll('.netlify-identity-widget, iframe[src*="netlify-identity-widget"]');
          existingModals.forEach(modal => {
            debugLog('üóëÔ∏è Removing existing modal element');
            modal.remove();
          });
          
          // Force re-initialization
          identityWidget.init({
            APIUrl: window.location.origin + '/.netlify/identity',
            logo: 'https://i.postimg.cc/x8zq9Qvf/2025-06-29-T075316-796.png',
            namePlaceholder: 'Nom complet',
            locale: 'fr'
          });
          
          debugLog('‚úÖ Widget force initialization completed');
          return true;
        } catch (error) {
          debugLog(`‚ùå ERROR in force initialization: ${error.message}`);
          return false;
        }
      }
      
      // Enhanced login function with modal visibility checking
      function openLogin() {
        loginAttempts++;
        debugLog(`üöÄ Login attempt #${loginAttempts}`);
        
        if (!checkNetlifyIdentity()) {
          updateAuthStatus('Service d\'authentification non disponible');
          showCustomLoginOption();
          return;
        }
        
        try {
          updateAuthStatus('Ouverture de la fen√™tre de connexion...');
          setLoginButtonState(true, 'Connexion en cours...');
          
          // Clear any existing modal check interval
          if (modalCheckInterval) {
            clearInterval(modalCheckInterval);
          }
          
          debugLog('üîì Calling netlifyIdentity.open("login")...');
          window.netlifyIdentity.open('login');
          
          // Start checking for modal visibility
          let modalCheckCount = 0;
          const maxModalChecks = 10; // 5 seconds
          
          modalCheckInterval = setInterval(() => {
            modalCheckCount++;
            debugLog(`üëÄ Modal check #${modalCheckCount}/${maxModalChecks}`);
            
            const modalVisible = checkModalVisibility();
            
            if (modalVisible) {
              debugLog('‚úÖ Modal is visible, stopping checks');
              clearInterval(modalCheckInterval);
              updateAuthStatus('Fen√™tre de connexion ouverte');
            } else if (modalCheckCount >= maxModalChecks) {
              debugLog('‚ùå Modal not visible after maximum checks');
              clearInterval(modalCheckInterval);
              
              // Try alternative approaches
              tryAlternativeLoginMethods();
            }
          }, 500);
          
          // Fallback timeout
          setTimeout(() => {
            if (!isAuthenticated && modalCheckInterval) {
              debugLog('‚è∞ Login timeout reached');
              clearInterval(modalCheckInterval);
              setLoginButtonState(false, 'Se connecter');
              updateAuthStatus('D√©lai d\'attente d√©pass√©');
              showCustomLoginOption();
            }
          }, 15000);
          
        } catch (error) {
          debugLog(`‚ùå ERROR opening login: ${error.message}`);
          updateAuthStatus('Erreur lors de l\'ouverture de la connexion');
          setLoginButtonState(false, 'R√©essayer');
          showCustomLoginOption();
        }
      }
      
      // Try alternative login methods
      function tryAlternativeLoginMethods() {
        debugLog('üîÑ Trying alternative login methods...');
        
        // Method 1: Force widget refresh
        setTimeout(() => {
          if (!isAuthenticated) {
            debugLog('üìã Alternative Method 1: Force widget refresh');
            try {
              window.netlifyIdentity.refresh();
              window.netlifyIdentity.open('login');
              
              setTimeout(() => {
                if (!checkModalVisibility()) {
                  debugLog('‚ùå Method 1 failed');
                  tryMethod2();
                }
              }, 2000);
            } catch (e) {
              debugLog(`‚ùå Method 1 error: ${e.message}`);
              tryMethod2();
            }
          }
        }, 1000);
      }
      
      function tryMethod2() {
        debugLog('üìã Alternative Method 2: Complete reinitialization');
        try {
          forceInitializeWidget();
          setTimeout(() => {
            window.netlifyIdentity.open('login');
            
            setTimeout(() => {
              if (!checkModalVisibility()) {
                debugLog('‚ùå Method 2 failed');
                tryMethod3();
              }
            }, 2000);
          }, 1000);
        } catch (e) {
          debugLog(`‚ùå Method 2 error: ${e.message}`);
          tryMethod3();
        }
      }
      
      function tryMethod3() {
        debugLog('üìã Alternative Method 3: Manual DOM injection');
        try {
          // Create a manual modal trigger
          const triggerEvent = new CustomEvent('netlify-identity:open', {
            detail: { tab: 'login' }
          });
          window.dispatchEvent(triggerEvent);
          
          setTimeout(() => {
            if (!checkModalVisibility()) {
              debugLog('‚ùå Method 3 failed, showing custom login');
              showCustomLoginOption();
            }
          }, 2000);
        } catch (e) {
          debugLog(`‚ùå Method 3 error: ${e.message}`);
          showCustomLoginOption();
        }
      }
      
      // Show custom login option
      function showCustomLoginOption() {
        debugLog('üîß Showing custom login option');
        const customBtn = document.getElementById('customLoginButton');
        if (customBtn) {
          customBtn.style.display = 'inline-block';
          updateAuthStatus('Probl√®me avec la fen√™tre de connexion. Utilisez la connexion alternative.');
        }
      }
      
      // Show custom login form
      function showCustomLogin() {
        debugLog('üìù Showing custom login form');
        document.getElementById('authRequired').style.display = 'none';
        document.getElementById('customLoginForm').style.display = 'flex';
      }
      
      // Show main auth screen
      function showMainAuth() {
        debugLog('üîô Showing main auth screen');
        document.getElementById('customLoginForm').style.display = 'none';
        document.getElementById('authRequired').style.display = 'flex';
      }
      
      // Handle custom login form
      function handleCustomLogin(email, password) {
        debugLog(`üìß Attempting custom login for: ${email}`);
        
        if (!window.netlifyIdentity || !window.netlifyIdentity.gotrue) {
          throw new Error('Netlify Identity GoTrue not available');
        }
        
        const submitBtn = document.getElementById('submitLogin');
        const errorDiv = document.getElementById('loginError');
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Connexion...';
        errorDiv.style.display = 'none';
        
        // Use GoTrue API directly
        window.netlifyIdentity.gotrue.login(email, password, true)
          .then(user => {
            debugLog(`‚úÖ Custom login successful: ${user.email}`);
            isAuthenticated = true;
            setUser(user);
            showMainAuth();
            initializeCMS();
          })
          .catch(error => {
            debugLog(`‚ùå Custom login failed: ${error.message}`);
            errorDiv.textContent = 'Email ou mot de passe incorrect';
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Se connecter';
          });
      }
      
      // Initialize Netlify Identity with comprehensive error handling
      function initializeNetlifyIdentity() {
        debugLog('üîß Starting Netlify Identity initialization...');
        
        if (!checkNetlifyIdentity()) {
          updateAuthStatus('Service d\'authentification non disponible');
          return false;
        }
        
        if (identityInitialized) {
          debugLog('‚úÖ Identity already initialized');
          return true;
        }
        
        try {
          updateAuthStatus('Initialisation du service d\'authentification...');
          
          // Set up comprehensive event listeners
          window.netlifyIdentity.on("init", user => {
            debugLog(`üéØ Identity initialized with user: ${user ? user.email : 'no user'}`);
            identityInitialized = true;
            
            if (user) {
              isAuthenticated = true;
              updateAuthStatus('Utilisateur connect√©, chargement du CMS...');
              initializeCMS();
            } else {
              updateAuthStatus('Veuillez vous connecter pour continuer');
              showAuthRequired();
            }
          });
          
          window.netlifyIdentity.on("login", user => {
            debugLog(`‚úÖ User logged in: ${user.email}`);
            isAuthenticated = true;
            updateAuthStatus('Connexion r√©ussie! Chargement du CMS...');
            hideAuthRequired();
            initializeCMS();
          });
          
          window.netlifyIdentity.on("logout", () => {
            debugLog("üëã User logged out");
            isAuthenticated = false;
            updateAuthStatus('D√©connexion effectu√©e');
            window.location.href = "/admin-login";
          });
          
          window.netlifyIdentity.on("error", err => {
            debugLog(`‚ùå Identity error: ${err.message || err}`);
            updateAuthStatus('Erreur d\'authentification: ' + (err.message || 'Erreur inconnue'));
            showAuthRequired();
            setLoginButtonState(false, 'R√©essayer');
            showCustomLoginOption();
          });
          
          window.netlifyIdentity.on("open", () => {
            debugLog("üîì Identity modal opened");
            updateAuthStatus('Fen√™tre de connexion ouverte');
            if (modalCheckInterval) {
              clearInterval(modalCheckInterval);
            }
          });
          
          window.netlifyIdentity.on("close", () => {
            debugLog("üîí Identity modal closed");
            setLoginButtonState(false, 'Se connecter');
            if (!isAuthenticated) {
              updateAuthStatus('Connexion annul√©e');
            }
          });
          
          // Initialize the widget
          debugLog('üîß Calling netlifyIdentity.init()...');
          window.netlifyIdentity.init({
            APIUrl: window.location.origin + '/.netlify/identity',
            logo: 'https://i.postimg.cc/x8zq9Qvf/2025-06-29-T075316-796.png'
          });
          
          return true;
          
        } catch (error) {
          debugLog(`‚ùå ERROR initializing Identity: ${error.message}`);
          updateAuthStatus('Erreur lors de l\'initialisation');
          return false;
        }
      }
      
      function initializeCMS() {
        if (cmsInitialized) {
          debugLog('‚úÖ CMS already initialized');
          return;
        }
        
        try {
          updateAuthStatus('Initialisation du CMS...');
          debugLog('üîß Starting CMS initialization...');
          
          if (typeof window.CMS === 'undefined') {
            throw new Error('Netlify CMS not loaded');
          }
          
          window.CMS.init({
            config: {
              load_config_file: true,
              config_file_path: '/admin/config.yml'
            }
          });
          
          cmsInitialized = true;
          hideLoadingScreen();
          updateAuthStatus('CMS charg√© avec succ√®s!');
          debugLog("‚úÖ CMS initialized successfully");
          
        } catch (error) {
          debugLog(`‚ùå ERROR initializing CMS: ${error.message}`);
          updateAuthStatus('Erreur lors du chargement du CMS');
          showAuthRequired();
        }
      }
      
      function showLoadingScreen() {
        debugLog('üì∫ Showing loading screen');
        document.getElementById('loadingScreen').style.display = 'flex';
        document.getElementById('authRequired').style.display = 'none';
        document.getElementById('customLoginForm').style.display = 'none';
      }
      
      function hideLoadingScreen() {
        debugLog('üì∫ Hiding loading screen');
        const loadingScreen = document.getElementById('loadingScreen');
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);
      }
      
      function showAuthRequired() {
        debugLog('üì∫ Showing auth required screen');
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('authRequired').style.display = 'flex';
        document.getElementById('customLoginForm').style.display = 'none';
        setLoginButtonState(false, 'Se connecter');
      }
      
      function hideAuthRequired() {
        debugLog('üì∫ Hiding auth required screen');
        document.getElementById('authRequired').style.display = 'none';
        document.getElementById('customLoginForm').style.display = 'none';
        showLoadingScreen();
      }
      
      function goHome() {
        debugLog('üè† Redirecting to home page');
        window.location.href = '/';
      }
      
      // Set up event listeners
      function setupEventListeners() {
        debugLog('üîß Setting up event listeners...');
        
        // Login button
        const loginBtn = document.getElementById('loginButton');
        if (loginBtn) {
          loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            debugLog('üñ±Ô∏è Login button clicked');
            openLogin();
          });
        }
        
        // Custom login button
        const customLoginBtn = document.getElementById('customLoginButton');
        if (customLoginBtn) {
          customLoginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            debugLog('üñ±Ô∏è Custom login button clicked');
            showCustomLogin();
          });
        }
        
        // Home button
        const homeBtn = document.getElementById('homeButton');
        if (homeBtn) {
          homeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            debugLog('üñ±Ô∏è Home button clicked');
            goHome();
          });
        }
        
        // Custom login form
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
          loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            handleCustomLogin(email, password);
          });
        }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        debugLog('üöÄ DOM Content Loaded - Starting initialization');
        updateAuthStatus('Chargement de la page d\'administration...');
        
        setupEventListeners();
        
        let checkCount = 0;
        const maxChecks = 40;
        
        function checkAndInit() {
          checkCount++;
          debugLog(`üîç Check #${checkCount}/${maxChecks} for Netlify Identity...`);
          
          if (checkNetlifyIdentity()) {
            debugLog('‚úÖ Netlify Identity found, initializing...');
            
            if (initializeNetlifyIdentity()) {
              const user = window.netlifyIdentity?.currentUser();
              if (user) {
                debugLog(`üë§ User already authenticated: ${user.email}`);
                isAuthenticated = true;
                updateAuthStatus('Utilisateur d√©j√† connect√©, chargement du CMS...');
                initializeCMS();
              } else {
                debugLog('üë§ No authenticated user found');
                updateAuthStatus('Authentification requise');
                showAuthRequired();
              }
            } else {
              debugLog('‚ùå Failed to initialize Netlify Identity');
              updateAuthStatus('Impossible de charger le service d\'authentification');
              showAuthRequired();
            }
          } else if (checkCount < maxChecks) {
            debugLog(`‚è≥ Netlify Identity not ready, retrying in 500ms...`);
            setTimeout(checkAndInit, 500);
          } else {
            debugLog('‚ùå Max checks reached, Netlify Identity not available');
            updateAuthStatus('Service d\'authentification non disponible');
            showAuthRequired();
            showCustomLoginOption();
          }
        }
        
        checkAndInit();
      });
      
      // Global functions
      window.showMainAuth = showMainAuth;
      window.showCustomLogin = showCustomLogin;
      
      // Enhanced debugging functions
      window.adminDebug = {
        openLogin,
        checkNetlifyIdentity,
        checkModalVisibility,
        initializeNetlifyIdentity,
        forceInitializeWidget,
        debugLogs,
        clearLogs: () => {
          debugLogs = [];
          updateDebugPanel();
        },
        toggleDebug: () => {
          const panel = document.getElementById('debugPanel');
          panel.classList.toggle('show');
        },
        state: () => ({
          isAuthenticated,
          cmsInitialized,
          identityInitialized,
          loginAttempts,
          identityWidget: !!identityWidget,
          currentUser: window.netlifyIdentity?.currentUser?.()
        }),
        testLogin: () => {
          debugLog('üß™ Manual test login triggered');
          openLogin();
        },
        showCustomLogin,
        showMainAuth
      };
      
      // Auto-show debug panel after 3 seconds if not authenticated
      setTimeout(() => {
        if (!isAuthenticated) {
          debugLog('üîß Auto-showing debug panel for troubleshooting');
          window.adminDebug.toggleDebug();
        }
      }, 3000);
    </script>
  </body>
</html>